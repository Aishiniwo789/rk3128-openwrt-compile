name: Build RK3128 Printer Server

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Initialize Environment
      run: |
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android /opt/ghcup
        sudo apt-get update -qq
        sudo apt-get install -y build-essential libncurses-dev libssl-dev python3 python3-distutils perl tar wget curl ca-certificates git swig unzip
        
    - name: Clone OpenWrt Source
      run: |
        git clone --depth 1 -b openwrt-23.05 https://github.com/openwrt/openwrt.git source
        cd source
        
    - name: Update Feeds
      run: |
        cd source && ./scripts/feeds update -a
        
    - name: Install Packages
      run: |
        cd source && ./scripts/feeds install -a
        
    - name: Create Custom Config
      run: |
        cd source && cat > .config << EOF
        CONFIG_TARGET_rockchip=y
        CONFIG_TARGET_rockchip_armv7=y
        CONFIG_TARGET_rockchip_armv7_DEVICE_rk3128_tvbox=y
        CONFIG_TARGET_OPTIONS=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=128
        CONFIG_PACKAGE_kmod-usb-printer=y
        CONFIG_PACKAGE_usb-printer=y
        CONFIG_PACKAGE_cups-bjnp=y
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_kmod-cupsusb=y
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-ohci=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb3=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        CONFIG_PACKAGE_kmod-nls-cp437=y
        CONFIG_PACKAGE_kmod-nls-iso8859-1=y
        CONFIG_PACKAGE_luci-app-cups=y
        CONFIG_PACKAGE_luci-i18n-cups-zh-cn=y
        CONFIG_PACKAGE_luci-proto-ppp=y
        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_DEVEL_SHORT_COMMIT_ID=y
        CONFIG_TARGET_IMAGES_GZIP=n
        CONFIG_TARGET_IMAGES_PAD=n
        CONFIG_PACKAGE_kmod-leds-gpio=y
        CONFIG_PACKAGE_kmod-gpio-button-hotplug=y
        EOF
        
    - name: Defconfig
      run: |
        cd source && make defconfig
        
    - name: Compile Firmware
      run: |
        cd source && make -j $ (nproc) DOWNLOAD_ROOT_DIR=/home/runner/work/ $ (basename  $ GITHUB_REPOSITORY)/downloads
        
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-RK3128-Firmware
        path: |
          source/bin/targets/rockchip/armv7/
          !source/bin/targets/rockchip/armv7/packages
          !source/bin/targets/rockchip/armv7/debug
          !source/bin/targets/rockchip/armv7/profiles.json
          !source/bin/targets/rockchip/armv7/Config-buildinfo
