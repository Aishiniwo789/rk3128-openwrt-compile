name: Build RK3128 Printer Server

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Initialize Environment
      run: |
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android /opt/ghcup
        sudo apt-get update -qq
        sudo apt-get install -y build-essential libncurses-dev libssl-dev python3 python3-distutils perl tar wget curl ca-certificates git swig unzip
        
    - name: Clone OpenWrt Source
      run: |
        git clone --depth 1 -b openwrt-23.05 https://github.com/openwrt/openwrt.git source
        cd source
        
    - name: Update Feeds
      run: |
        cd source && ./scripts/feeds update -a
        
    - name: Install Packages
      run: |
        cd source && ./scripts/feeds install -a
        
    - name: Create Custom Config
      run: |
        cd source && cat > .config << EOF
        CONFIG_TARGET_rockchip=y
        CONFIG_TARGET_rockchip_armv7=y
        CONFIG_TARGET_rockchip_armv7_DEVICE_rk3128_tvbox=y
        CONFIG_TARGET_OPTIONS=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=128
        CONFIG_PACKAGE_kmod-usb-printer=y
        CONFIG_PACKAGE_usb-printer=y
        CONFIG_PACKAGE_cups-bjnp=y
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_kmod-cupsusb=y
        CONFIG_PACKAGE_kmod-usb
